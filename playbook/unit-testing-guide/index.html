<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/Data-Platform-Playbook/blog/rss.xml" title="Hackney Data Platform Playbook Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Data-Platform-Playbook/blog/atom.xml" title="Hackney Data Platform Playbook Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Hackney Data Platform Playbook" href="/Data-Platform-Playbook/opensearch.xml"><title data-react-helmet="true">Guide to testing on the Data Platform | Hackney Data Platform Playbook</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Guide to testing on the Data Platform | Hackney Data Platform Playbook"><meta data-react-helmet="true" name="description" content="A beginners guide to testing on the data platform"><meta data-react-helmet="true" property="og:description" content="A beginners guide to testing on the data platform"><meta data-react-helmet="true" property="og:url" content="https://playbook.hackney.gov.uk/Data-Platform-Playbook//Data-Platform-Playbook/playbook/unit-testing-guide"><link data-react-helmet="true" rel="shortcut icon" href="/Data-Platform-Playbook/img/favicon.png"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://playbook.hackney.gov.uk/Data-Platform-Playbook//Data-Platform-Playbook/playbook/unit-testing-guide"><link rel="stylesheet" href="/Data-Platform-Playbook/styles.2116970b.css">
<link rel="stylesheet" href="/Data-Platform-Playbook/main.4a16e2e4.css">
<link rel="preload" href="/Data-Platform-Playbook/styles.fddac7b9.js" as="script">
<link rel="preload" href="/Data-Platform-Playbook/runtime~main.f2cf3007.js" as="script">
<link rel="preload" href="/Data-Platform-Playbook/main.b6e5ad1b.js" as="script">
<link rel="preload" href="/Data-Platform-Playbook/1.9e05305b.js" as="script">
<link rel="preload" href="/Data-Platform-Playbook/2.efca4e8b.js" as="script">
<link rel="preload" href="/Data-Platform-Playbook/53.65dc9dbb.js" as="script">
<link rel="preload" href="/Data-Platform-Playbook/56.bfe8f6c1.js" as="script">
<link rel="preload" href="/Data-Platform-Playbook/935f2afb.4f030d3b.js" as="script">
<link rel="preload" href="/Data-Platform-Playbook/17896441.a78032d3.js" as="script">
<link rel="preload" href="/Data-Platform-Playbook/15517f07.3669bbe2.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/Data-Platform-Playbook/"><img src="/Data-Platform-Playbook/img/logo-long.svg" alt="Data Platform Playbook" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/Data-Platform-Playbook/img/logo-long.svg" alt="Data Platform Playbook" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Data Platform Playbook</strong></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/LBHackney-IT/data-platform-playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/Data-Platform-Playbook/"><img src="/Data-Platform-Playbook/img/logo-long.svg" alt="Data Platform Playbook" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/Data-Platform-Playbook/img/logo-long.svg" alt="Data Platform Playbook" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Data Platform Playbook</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/LBHackney-IT/data-platform-playbook" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/Data-Platform-Playbook/release-notes">Release Notes</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">About</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/zones">Zones</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/environments">Environments</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Playbook</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/connecting-to-redshift-from-data-studio">Connecting to the redshift cluster from Google Data Studio</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/data-quality-testing-guide">Guide to testing data quality in Glue Jobs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/exporting-snapshot-to-landing-zone">Exporting database snapshot to the Data Platform Landing Zone</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/google-sheets-import">Google Sheets import</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/import-files-from-google-to-S3">Import files from google to s3</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/import-xlsx-from-g-drive">Import XLXS from G Drive</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/ingest-data-from-csv-files">Ingest manually uploaded csv files</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/onboarding-new-users-to-the-platform">Onboarding new users to the platform</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/querying-data-using-sql">Querying the Platform using SQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/scheduling-liberator-glue-jobs">Scheduling Liberator Glue Jobs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/Data-Platform-Playbook/playbook/unit-testing-guide">Guide to testing on the Data Platform</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/playbook/using-glue-studio">Using Glue Studio</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Data-Platform-Playbook/workshop/aws_glue_studio_parking">Glue Studio workshop with Parking Analysts</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Technical Documentation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/docs/docs">Docs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/docs/exporting-snapshot-to-landing-zone">Exporting database snapshots to the Data Platform Landing Zone</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/docs/import-xlsx-from-g-drive">Import XLXS from G Drive</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/docs/redshift">Redshift Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/docs/vpc-peering-connection-dataplatform-and-production-apis-account">VPC Peering Connection between Data Platform and Production APIs AWS accounts</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Architecture Decision</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/index">Introduction</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Records</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/0001-record-architecture-decisions">Record architecture decisions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/0002-ingest-google-sheets-data">Ingest Google Sheets Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/0003-role-based-access-control">Role-Based Access Control</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/0004-partition-strategy">Partition Strategy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/0005-recovered-data">Recovered Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/0006-ingest-sql-flat-files">Ingest SQL flat files</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/0007-sftp-to-s3-lambda">Copy Liberator data from sftp to s3</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/0008-production-data-in-staging">production-data-in-staging</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/0009-ingesting-data-from-apis">Ingesting data from APIs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/0010-using-pytest-for-verifying-pyspark-transformations">Using pytest for verifying PySpark transformations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/architecture-decisions/index">Introduction</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Spikes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/spikes/0005-qlik-integration">Qlik Integration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/spikes/0007-data-quality-testing">Data Quality Testing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/spikes/0008-datahub-deployment">Datahub deployment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Data-Platform-Playbook/spikes/0009-amundsen-deployment">Amundsen deployment</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Guide to testing on the Data Platform</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="context"></a>Context<a class="hash-link" href="#context" title="Direct link to heading">#</a></h2><p>Historically, unit testing practices have helped:</p><ul><li>Improve the speed at which PySpark scripts can be developed</li><li>Provide documentation for each script with example data they
expect, and what results they output </li><li>Increase the proportion of defects found before they reach staging environment</li><li>Help those who come to maintain your script make their change without being scared
of breaking existing functionality</li></ul><p>The most valuable code to test is the code which is subject to change,
and has some complicated behaviour. We recommend that when writing PySpark
code which isnâ€™t exceedingly simple that you write some tests alongside that production code.</p><p>HackIT have produced <a href="https://www.youtube.com/embed/M-_F_Tr6paQ" target="_blank" rel="noopener noreferrer">a video describing unit testing principles for C#</a>
which are transferable to Spark scripts.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="organising-your-code-so-it-can-be-tested"></a>Organising your code so it can be tested<a class="hash-link" href="#organising-your-code-so-it-can-be-tested" title="Direct link to heading">#</a></h2><p>Writing tests around your spark scripts require them to be written in a way which makes them easy to test.</p><p>Using <a href="https://github.com/LBHackney-IT/Data-Platform/blob/2e4a89e280c326576a976b4f28c9b7faaa691ea4/scripts/address_cleaning.py#L16-L99" target="_blank" rel="noopener noreferrer">address cleaning</a> as an example script, we have
extracted all DataFrame manipulation code into a method, and then tested
the behaviours of that <a href="https://github.com/LBHackney-IT/Data-Platform/blob/2e4a89e280c326576a976b4f28c9b7faaa691ea4/scripts/test_address_cleaning.py#L7-L15" target="_blank" rel="noopener noreferrer">with tests</a>.</p><p>The &quot;main&quot; part of the ETL job which will run within the AWS Glue environment
is then <a href="https://github.com/LBHackney-IT/Data-Platform/blob/2e4a89e280c326576a976b4f28c9b7faaa691ea4/scripts/address_cleaning.py#L103-L140" target="_blank" rel="noopener noreferrer">wrapped in a conditional</a> which prevents
that code from being run within the testing environment. All code, except import statements, that isn&#x27;t in a method should be included in this conditional.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="writing-your-own-tests"></a>Writing your own tests<a class="hash-link" href="#writing-your-own-tests" title="Direct link to heading">#</a></h2><ul><li>Ensure that you run the tests and that they are all passing before writing your own tests.
See <a href="https://github.com/LBHackney-IT/Data-Platform/blob/main/scripts/README.md" target="_blank" rel="noopener noreferrer">README.md</a> for instructions on how to do this</li><li>The tests are stored in the scripts folder of the project alongside the glue scripts themselves.
Start by creating your own glue job script as usual, <code>script_name.py</code>, and also a test file <code>test_script_name.py</code>.<br>Test files should be named with &quot;test&quot; at the beginning of the file. For example, <code>test_cleaning_script.py</code>.<ul><li>You will need to organise your script according to the <a href="#organising-your-code-so-it-can-be-tested">Organising your code so it can be tested</a> above</li></ul></li><li>Define a function within <code>script_name.py</code>, which takes in the input DataFrame(s), and returns the DataFrame to be written.</li><li>Within your <code>test_script_name.py</code> start creating tests.
You can use the <a href="https://github.com/LBHackney-IT/Data-Platform/blob/main/scripts/test_spark_example.py" target="_blank" rel="noopener noreferrer">test_spark_example</a> as a template and <a href="https://github.com/LBHackney-IT/Data-Platform/blob/2e4a89e280c326576a976b4f28c9b7faaa691ea4/scripts/address_cleaning.py#L16-L99" target="_blank" rel="noopener noreferrer">address cleaning</a> as an example of a fully tested script.
Test method names should start with a &quot;test&quot; in their name, otherwise the tests wonâ€™t be run.
Ensure the name clearly describes what is being tested.
For example, if you are testing the behaviour of adding a unique id column, then a suitable name may be along the lines of <code>test_creates_unique_id_column</code>.</li><li>There are some helper functions in <code>unit_testing_helpers.py</code> which you can use in your tests.
If you do decide to use these functions, ensure you import them at the top of your test file.</li><li>If your script is using a logger, you will need to pass it into your testable method.
See the <code>clean_addresses</code> function in the <code>test_address_cleaning.py</code> for an example of how you can do this. </li></ul><p>We use the following things to help write and run tests against pyspark scripts.</p><ul><li>The testing framework that we use for the glue scripts is called <a href="https://docs.pytest.org/en/6.2.x/contents.html" target="_blank" rel="noopener noreferrer">Pytest</a>.</li><li><a href="https://docs.python.org/3/library/unittest.html" target="_blank" rel="noopener noreferrer">Unittest</a>, is a testing framework like pytest, that has some helpful features that we use in some of the tests.</li><li>Docker is used to run the tests locally.
We use a <a href="https://aws.amazon.com/blogs/big-data/developing-aws-glue-etl-jobs-locally-using-a-container/" target="_blank" rel="noopener noreferrer">docker image provided by amazon</a> that helps us replicate the environment that our glue jobs are run in.
It also has pyspark and pytest installed to allow us to easily run the tests. You will need <a href="https://docs.docker.com/get-docker/" target="_blank" rel="noopener noreferrer">docker installed</a> to run tests locally.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cicd-pipeline"></a>CI/CD Pipeline<a class="hash-link" href="#cicd-pipeline" title="Direct link to heading">#</a></h2><p>The tests will run each time a commit is made to a branch including when branches are merged into main.
The build will not run/deploy if there are failing tests.
This is to prevent breaking changes from being deployed to the Data Platform staging environment.</p><p>This has been configured in the <a href="https://github.com/LBHackney-IT/Data-Platform/blob/main/.github/workflows/data_platform_stg.yml" target="_blank" rel="noopener noreferrer">Github workflows configuration file</a></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/LBHackney-IT/data-platform-playbook/edit/master/docs/playbook/unit-testing-guide.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Data-Platform-Playbook/playbook/scheduling-liberator-glue-jobs"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Scheduling Liberator Glue Jobs</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/Data-Platform-Playbook/playbook/using-glue-studio"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Using Glue Studio Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#context" class="table-of-contents__link">Context</a></li><li><a href="#organising-your-code-so-it-can-be-tested" class="table-of-contents__link">Organising your code so it can be tested</a></li><li><a href="#writing-your-own-tests" class="table-of-contents__link">Writing your own tests</a></li><li><a href="#cicd-pipeline" class="table-of-contents__link">CI/CD Pipeline</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Made by HackIT.</div></div></div></footer></div>
<script src="/Data-Platform-Playbook/styles.fddac7b9.js"></script>
<script src="/Data-Platform-Playbook/runtime~main.f2cf3007.js"></script>
<script src="/Data-Platform-Playbook/main.b6e5ad1b.js"></script>
<script src="/Data-Platform-Playbook/1.9e05305b.js"></script>
<script src="/Data-Platform-Playbook/2.efca4e8b.js"></script>
<script src="/Data-Platform-Playbook/53.65dc9dbb.js"></script>
<script src="/Data-Platform-Playbook/56.bfe8f6c1.js"></script>
<script src="/Data-Platform-Playbook/935f2afb.4f030d3b.js"></script>
<script src="/Data-Platform-Playbook/17896441.a78032d3.js"></script>
<script src="/Data-Platform-Playbook/15517f07.3669bbe2.js"></script>
</body>
</html>